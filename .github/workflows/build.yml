name: Build Plugin

on:
  push:
    branches: [ main, fix/* ]
  pull_request:
    types: [ opened, synchronize, reopened ]
  workflow_dispatch:

env:
  BUILD_TYPE: RelWithDebInfo
  SOURCE_ROOT: ./build/modorganizer_super/${{ github.event.repository.name }}

jobs:
  build:
    runs-on: windows-2022
    steps:
      - name: Build Dependencies
        id: build-deps
        uses: ModOrganizer2/build-with-mob-action@master
        with:
          mo2-dependencies: cmake_common uibase lz4
          mo2-skip-configure: true
          qt-modules: qtpositioning qtwebchannel qtwebengine

      - name: Install vcpkg dependencies
        run: |
          vcpkg install boost-headers:x64-windows-static-md boost-signals2:x64-windows-static-md

      - name: Configure
        run: |
          cd build/mo2-notes
          cmake --preset vs2022-windows-ci `
            "-DCMAKE_PREFIX_PATH=${{steps.build-deps.outputs.cmake-prefix-path}};C:\vcpkg\installed\x64-windows-static-md" `
            "-DCMAKE_INSTALL_PREFIX=${{steps.build-deps.outputs.cmake-install-path}}"

      - name: Build
        run: cmake --build build/mo2-notes/vsbuild --config ${{env.BUILD_TYPE}} --parallel

      - name: Install
        run: cmake --install build/mo2-notes/vsbuild --config ${{env.BUILD_TYPE}} --prefix build/mo2-notes/install

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: mo2-notes
          path: build/mo2-notes/install/bin